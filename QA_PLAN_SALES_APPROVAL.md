# תכנית בדיקה - מודול אישור/דחיית דרישות תשלום

## מטרת הבדיקה
לוודא שתהליך אישור ודחיית דרישות תשלום ע"י הגזבר/מנהל חשבונות עובד כראוי.

---

## תרחישי בדיקה

### 1️⃣ יצירת דרישת תשלום (מנהל ענף)
**דרישות מוקדמות:**
- משתמש מחובר כמנהל ענף
- קיים לקוח מאושר בענף

**צעדי בדיקה:**
1. כניסה לפורטל מנהל הענף
2. בחירת לקוח מרשימת הלקוחות
3. לחיצה על "צור דרישת תשלום חדשה"
4. מילוי הטופס:
   - תאריך עסקה
   - סכום העסקה (ללא מע"מ)
   - תיאור (אופציונלי)
5. וידוא שסכום כולל מע"מ מחושב אוטומטית (× 1.18)
6. לחיצה על "שלח לאישור"

**תוצאה צפויה:**
- הודעת הצלחה
- דרישת התשלום מופיעה בווידג'יט "סטטוס עסקאות" עם סטטוס "ממתין לאישור"
- פעמון התראות של הגזבר מתעדכן (+1)

---

### 2️⃣ צפייה בדרישות תשלום ממתינות (גזבר)
**דרישות מוקדמות:**
- קיימת לפחות דרישת תשלום אחת בסטטוס "pending_approval"

**צעדי בדיקה:**
1. כניסה לדשבורד הגזבר
2. גלילה לווידג'יט "דרישות תשלום ממתינות לאישור"
3. בדיקת המידע המוצג:
   - שם הלקוח
   - מספר לקוח
   - ענף
   - סכום
   - תאריך עסקה
   - תיאור

**תוצאה צפויה:**
- הווידג'יט מציג את כל דרישות התשלום הממתינות
- המידע תואם למה שהוזן על ידי מנהל הענף

---

### 3️⃣ אישור דרישת תשלום - זרימה תקינה
**צעדי בדיקה:**
1. לחיצה על כפתור "אשר" ליד דרישת תשלום
2. וידוא שנפתח טופס אישור עם:
   - פרטי הלקוח והעסקה
   - חישוב מע"מ (סכום ללא, מע"מ 18%, סכום כולל)
   - שדה תנאי תשלום (ברירת מחדל: שוטף 50+)
   - שדה מספר חשבונית (חובה)
3. בחירת תנאי תשלום מהרשימה
4. הזנת מספר חשבונית (לדוגמה: "INV123456")
5. לחיצה על "אשר דרישת תשלום"
6. וידוא הופעת חלון אישור "האם אתה בטוח שברצונך לאשר?"
7. לחיצה על "אישור" בחלון

**תוצאה צפויה:**
- הודעת הצלחה "✅ דרישת התשלום אושרה בהצלחה!"
- דרישת התשלום נעלמת מהרשימה
- פעמון התראות מתעדכן (-1)
- מנהל הענף מקבל התראה על האישור

**בדיקות נוספות:**
- לחיצה על "ביטול" בחלון האישור → הפעולה מתבטלת
- לחיצה על "ביטול" בטופס → הטופס נסגר ללא שמירה

---

### 4️⃣ אישור דרישת תשלום - ללא מספר חשבונית
**צעדי בדיקה:**
1. לחיצה על כפתור "אשר" ליד דרישת תשלום
2. השארת שדה "מספר חשבונית" ריק
3. לחיצה על "אשר דרישת תשלום"

**תוצאה צפויה:**
- הודעת שגיאה: "❌ מספר חשבונית הוא שדה חובה"
- הטופס נשאר פתוח
- לא מתבצעת שליחה לשרת

---

### 5️⃣ דחיית דרישת תשלום - זרימה תקינה
**צעדי בדיקה:**
1. לחיצה על כפתור "דחה" ליד דרישת תשלום
2. וידוא שנפתח טופס דחייה בצבע אדום
3. הזנת סיבת דחייה בשדה הטקסט (לדוגמה: "מסמכים חסרים")
4. לחיצה על "דחה דרישת תשלום"
5. וידוא הופעת חלון אישור "האם אתה בטוח שברצונך לדחות?"
6. לחיצה על "אישור" בחלון

**תוצאה צפויה:**
- הודעת הצלחה "✅ דרישת התשלום נדחתה"
- דרישת התשלום נעלמת מהרשימה
- פעמון התראות מתעדכן (-1)
- מנהל הענף מקבל התראה על הדחייה כולל הסיבה

---

### 6️⃣ דחיית דרישת תשלום - ללא סיבה
**צעדי בדיקה:**
1. לחיצה על כפתור "דחה" ליד דרישת תשלום
2. השארת שדה "סיבת הדחייה" ריק
3. לחיצה על "דחה דרישת תשלום"

**תוצאה צפויה:**
- הודעת שגיאה: "❌ יש לציין סיבת דחייה"
- הטופס נשאר פתוח
- לא מתבצעת שליחה לשרת

---

### 7️⃣ פעמון התראות
**צעדי בדיקה:**
1. בדיקת המספר המוצג בפעמון ההתראות
2. יצירת דרישת תשלום חדשה
3. וידוא שהמספר בפעמון עלה ב-1
4. אישור/דחיית דרישת תשלום
5. וידוא שהמספר בפעמון ירד ב-1

**תוצאה צפויה:**
- הפעמון מציג את המספר הנכון של:
  - בקשות ספקים ממתינות
  - בקשות לקוחות ממתינות
  - דרישות תשלום ממתינות

---

### 8️⃣ בדיקות Backend
**צעדי בדיקה:**
1. בדיקת endpoint: `GET /api/sales/pending-approval`
   - מחזיר את כל דרישות התשלום הממתינות
   - כולל פרטי לקוח מלאים
2. בדיקת endpoint: `PUT /api/sales/:id/approve`
   - דורש מספר חשבונית
   - מעדכן סטטוס ל-"open"
   - שומר תנאי תשלום ומספר חשבונית
   - שולח התראה למנהל הענף
3. בדיקת endpoint: `PUT /api/sales/:id/reject`
   - דורש סיבת דחייה
   - מעדכן סטטוס ל-"rejected"
   - שומר סיבת דחייה
   - שולח התראה למנהל הענף
4. בדיקת endpoint: `GET /api/notifications/pending-requests-count`
   - מחזיר ספירה נכונה של כל הבקשות הממתינות
   - כולל פירוט לפי סוג בקשה

---

### 9️⃣ בדיקות Database
**שאילתות לבדיקה:**
```sql
-- 1. כל דרישות התשלום הממתינות
SELECT s.*, t.*, c.name as client_name 
FROM sale s
JOIN transaction t ON s.transaction_id = t.transaction_id
JOIN client c ON s.client_id = c.client_id
WHERE t.status = 'pending_approval';

-- 2. דרישות תשלום שאושרו
SELECT s.*, t.* 
FROM sale s
JOIN transaction t ON s.transaction_id = t.transaction_id
WHERE t.status = 'open' 
  AND s.invoice_number IS NOT NULL
ORDER BY t.due_date DESC;

-- 3. דרישות תשלום שנדחו
SELECT s.*, t.* 
FROM sale s
JOIN transaction t ON s.transaction_id = t.transaction_id
WHERE t.status = 'rejected'
ORDER BY t.due_date DESC;

-- 4. ספירת התראות ממתינות
SELECT 
  (SELECT COUNT(*) FROM supplier_requests WHERE status = 'pending') as suppliers,
  (SELECT COUNT(*) FROM client_request WHERE status = 'pending') as clients,
  (SELECT COUNT(*) FROM sale s JOIN transaction t ON s.transaction_id = t.transaction_id WHERE t.status = 'pending_approval') as sales;
```

---

## סיכום בדיקות
- [ ] יצירת דרישת תשלום
- [ ] צפייה בדרישות ממתינות
- [ ] אישור עם כל השדות
- [ ] אישור ללא מספר חשבונית (צריך להיכשל)
- [ ] דחייה עם סיבה
- [ ] דחייה ללא סיבה (צריך להיכשל)
- [ ] בדיקת אישורי "אתה בטוח?"
- [ ] בדיקת פעמון התראות
- [ ] בדיקות Backend endpoints
- [ ] בדיקות Database

---

## שגיאות ידועות
1. ❌ שגיאה בדחיית תשלום - **נמצאת בחקירה**
2. ❌ שגיאה באישור תשלום - **נמצאת בחקירה**


