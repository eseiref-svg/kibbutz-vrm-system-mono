# תוכנית QA - ניהול לקוחות ודרישות תשלום

## 📋 הוראות שימוש
- ✅ = עבר בהצלחה
- ❌ = נכשל  
- ⚠️ = חלקי / בעיה קלה
- ➖ = לא רלוונטי / לא בוצע

**נתיבים במערכת:**
- פורטל מנהל ענף: `http://localhost:3000` (לאחר התחברות כמנהל ענף)
- דשבורד גזבר: `http://localhost:3000` (לאחר התחברות כגזבר)
- ניהול לקוחות (גזבר): `http://localhost:3000/clients`

**🔐 פרטי התחברות:**
- **מנהל ענף:** manager@test.com / 111222333
- **גזבר:** treasury@test.com / 111222333

**📊 הכנת נתוני בדיקה:**
1. הרץ את `test-data-qa-clients.sql` בטרמינל PostgreSQL:
   ```bash
   psql -U postgres -d naan_vrm -f test-data-qa-clients.sql
   ```
2. הסקריפט יוצר:
   - ✅ 3 לקוחות קיימים (ID: 100, 101, 102)
   - ✅ 2 sales קיימים (לקשר לקוחות לענף 1)
   - ✅ מוודא שמשתמשים פעילים

**🎯 תיקונים שבוצעו:**
1. ✅ **תיקון כפילויות לקוחות** - אישור בקשה ללקוח קיים יוצר sale חדש בלבד
2. ✅ **הצגת מספר לקוח** - כרטיסי לקוחות מציגים #client_id
3. ✅ **רענון התראות** - הפעמון מתרענן כל 5 שניות + מיידי אחרי פעולות
4. ✅ **תיקון dropdown** - הסרת "בחר אפשרות" לאחר בחירה

---

## 🚀 תהליך בדיקה מהיר (Quick Smoke Test)

**מטרה:** לוודא שהתיקונים הקריטיים עובדים

### ✅ צ'קליסט מהיר
| # | בדיקה | תוצאה | הערות |
|---|-------|--------|-------|
| 1 | נכנס כמנהל ענף → רואה כרטיסי לקוחות עם #ID | ⬜ | וודא שיש #100, #101, #102 |
| 2 | לחץ "הגש בקשה" → לחץ "בחר לקוח קיים" | ⬜ | רשימת לקוחות מופיעה |
| 3 | בחר לקוח #100 "חברת QA א" → פרטים מתמלאים | ⬜ | שדות נעולים |
| 4 | מלא סכום 15000 ותנאי "+30 ימים" → שלח | ⬜ | הודעת הצלחה |
| 5 | נכנס כגזבר → רואה בקשה חדשה בווידג'ט | ⬜ | מציין "לקוח קיים (#100)" |
| 6 | אשר את הבקשה → הצלחה | ⬜ | הבקשה נעלמת |
| 7 | **חזור למנהל ענף → בדוק לקוחות** | ⬜ | **יש רק 1 לקוח #100, לא כפילות!** |
| 8 | לחץ על לקוח #100 → רואה 2 עסקאות | ⬜ | העסקה הישנה + החדשה |

**סטטוס:** ⬜ ממתין לבדיקה

---

## 🔄 תהליך 1: בקשה ללקוח (End-to-End) - **נבדוק מחדש**

### 1.1 יצירת בקשה - פורטל מנהל ענף
**מיקום:** `פורטל מנהל ענף` → `ניהול לקוחות ודרישות תשלום` → כפתור `הגש בקשה`

| # | בדיקה | תוצאה | הערות |
|---|-------|--------|-------|
| 1.1.1 | כפתור "הגש בקשה ללקוח חדש" מופיע | ⬜ | **נבדוק מחדש** |
| 1.1.2 | לחיצה פותחת modal עם טופס | ⬜ | **נבדוק מחדש** |
| 1.1.3 | שדות חובה מסומנים ב-* (5 שדות) | ⬜ | שם לקוח, איש קשר, טלפון, סכום, תנאי תשלום |
| 1.1.4 | בחירת "לקוח קיים" מציגה רשימה + ממלאת פרטים | ⬜ | **נבדוק מחדש** - בדוק עם לקוח #17 |
| 1.1.5 | פרטי לקוח קיים נעולים (לא ניתן לערוך) | ⬜ | **נבדוק מחדש** |
| 1.1.6 | Validation: שדות חובה ריקים → שגיאה | ⬜ | |
| 1.1.7 | Validation: סכום לא תקין (0, שלילי, טקסט) → שגיאה | ⬜ | נסה: -100, 0, "abc" |
| 1.1.8 | Validation: אימייל לא תקין → שגיאה | ⬜ | נסה: "invalid-email" |
| 1.1.9 | שמירה תקינה (לקוח חדש) → הודעת הצלחה | ⬜ | |
| 1.1.10 | שמירה תקינה (לקוח קיים) → הודעת הצלחה | ⬜ | **קריטי לבדיקה!** |

**✅/❌ תהליך 1.1: ⬜ ממתין לבדיקה**

---

### 1.2 הופעת הבקשה - פורטל גזבר
**מיקום:** `דשבורד גזבר` → ווידג'ט `בקשות לקוחות חדשים להוספה`

| # | בדיקה | תוצאה | הערות |
|---|-------|--------|-------|
| 1.2.1 | ווידג'ט מופיע בדשבורד | ✅ | |
| 1.2.2 | בקשה חדשה מופיעה בטבלה (6 עמודות) | ✅ | שם, הוגש על ידי, ענף, סכום, תנאי תשלום, תאריך |
| 1.2.3 | בקשה ללקוח קיים מציגה "לקוח קיים (#ID)" | ✅ | |
| 1.2.4 | בקשה ללקוח חדש מציגה "לקוח חדש" | ✅ | |
| 1.2.5 | התראה ב-NotificationsBell עם הקישור | ✅ | תוקן! עכשיו סופר גם בקשות לקוחות וגם בקשות ספקים |

**✅/❌ תהליך 1.2: ✅ הושלם בהצלחה!**

---

### 1.3 אישור בקשה - פורטל גזבר **[קריטי - תוקן!]**
**מיקום:** `דשבורד גזבר` → `בקשות לקוחות` → כפתור `אשר`

| # | בדיקה | תוצאה | הערות |
|---|-------|--------|-------|
| 1.3.1 | לחיצה על "אשר" → dialog אישור | ⬜ | **נבדוק מחדש** |
| 1.3.2A | אישור (לקוח **חדש**) → נוצר client ב-DB | ⬜ | **קריטי!** יוצר לקוח חדש + sale |
| 1.3.2B | אישור (לקוח **קיים**) → לא נוצר client חדש | ⬜ | **קריטי!** רק sale חדש, לא לקוח כפול |
| 1.3.3 | אישור → נוצר transaction | ⬜ | בדוק: value, due_date, status=open |
| 1.3.4 | אישור → נוצר sale המקשר הכל | ⬜ | Sale מקשר client+transaction+branch |
| 1.3.5 | תאריך יעד נכון: מיידי=היום, +30/+60/+90 | ⬜ | plus_30 → 30 ימים מהיום |
| 1.3.6 | הבקשה נעלמת מהרשימה | ⬜ | |
| 1.3.7 | התראה למנהל הענף: "הבקשה אושרה" | ⬜ | |
| 1.3.8 | **בפורטל מנהל ענף: לא נוצר לקוח כפול** | ⬜ | **קריטי!** ללקוח קיים |

**✅/❌ תהליך 1.3: ⬜ ממתין לבדיקה - **תוקן התיקון הקריטי!****

---

### 1.4 דחיית בקשה - פורטל גזבר
**מיקום:** `דשבורד גזבר` → `בקשות לקוחות` → כפתור `דחה`

| # | בדיקה | תוצאה | הערות |
|---|-------|--------|-------|
| 1.4.1 | לחיצה על "דחה" → prompt להערות | ✅ | |
| 1.4.2 | דחייה בלי הערות → עובד | ✅ | |
| 1.4.3 | דחייה עם הערות → עובד | ✅ | |
| 1.4.4 | הבקשה נעלמת + לא נוצר client/sale | ✅ | status='rejected', approved_client_id=null, approved_sale_id=null |
| 1.4.5 | התראה למנהל: "הבקשה נדחתה [הערות]" | ✅ | |

**✅/❌ תהליך 1.4: ✅ הושלם בהצלחה!**

---

## 🔄 תהליך 2: חיפוש לקוחות - פורטל מנהל ענף
**מיקום:** `פורטל מנהל ענף` → `ניהול לקוחות ודרישות תשלום` → חיפוש

### 2.1 חיפוש בסיסי וסינון לפי ענף

| # | בדיקה | תוצאה | הערות |
|---|-------|--------|-------|
| 2.1.1 | שדה חיפוש + dropdown "סוג חיפוש" | ✅ | |
| 2.1.2 | Dropdown: "לפי שם", "לפי מספר לקוח" | ✅ | |
| 2.1.3 | ללא חיפוש → רק לקוחות עם sales לענף זה | ✅ | 3 לקוחות מוצגים (ראה תמונה) |
| 2.1.4 | חיפוש לפי שם חלקי מוצא תואמים | ✅ | |
| 2.1.5 | חיפוש לפי ID מדויק מוצא לקוח | ⏭️ | לא נבדק - אין מספרי לקוחות ידועים |
| 2.1.6 | Enter/כפתור "חיפוש" מפעיל | ✅ | |
| 2.1.7 | "נקה" מאפס ומציג הכל | ✅ | |
| 2.1.8 | חיפוש לא מוצא → הודעה מתאימה | ⏭️ | לא נבדק |

**✅/❌ תהליך 2.1: ✅ הושלם (עם תיקונים)**

**🐛 בעיות שזוהו ותוקנו:**
- כפילויות לקוחות - תוקן! (DISTINCT ON)
- מספר לקוח לא מוצג - תוקן! (נוסף #ID לכרטיסים)
- Dropdown "בחר אפשרות" נשאר - תוקן! (מוסתר אחרי בחירה)

---

## 🔄 תהליך 3: יצירת דרישת תשלום מלקוח קיים
**מיקום:** `פורטל מנהל ענף` → `ניהול לקוחות` → לחיצה על כרטיס לקוח

| # | בדיקה | תוצאה | הערות |
|---|-------|--------|-------|
| 3.1 | לחיצה על כרטיס לקוח → טופס "צור דרישת תשלום" | ⬜ | פרטי לקוח כבר מופיעים |
| 3.2 | שמירה → יוצר transaction + sale | ⬜ | בדוק: DB `transaction`, `sale` |
| 3.3 | transaction מסוג 'sale', status 'pending' | ⬜ | |
| 3.4 | התראה להנהלת חשבונות + הודעת הצלחה | ⬜ | |

**✅/❌ תהליך 3: _______**

---

## 🔄 תהליך 4: תקינות נתונים ומאזן

| # | בדיקה | תוצאה | הערות |
|---|-------|--------|-------|
| 4.1 | תנאי תשלום: Dropdown כולל 4 אופציות | ⬜ | מיידי, +30, +60, +90 |
| 4.2 | חישוב תאריך יעד נכון לפי תנאי תשלום | ⬜ | בדוק ב-DB `transaction.due_date` |
| 4.3 | אישור בקשה לא משנה מאזן (רק יצירת sale) | ⬜ | מאזן בפורטל מנהל ענף לא משתנה |
| 4.4 | סימון תשלום (mark-paid) מעדכן מאזן | ⬜ | בדוק: מאזן ענף בפורטל |

**✅/❌ תהליך 4: _______**

---

## 🔄 תהליך 5: סטטוסים והתראות

| # | בדיקה | תוצאה | הערות |
|---|-------|--------|-------|
| 5.1 | סטטוסים: pending → approved/rejected | ⬜ | בדוק: DB `client_request.status` |
| 5.2 | לא ניתן לאשר בקשה שכבר מטופלת | ⬜ | נסה לאשר שוב |
| 5.3 | התראות: בקשה חדשה → גזבר | ⬜ | |
| 5.4 | התראות: אישור/דחייה → מנהל ענף | ⬜ | |
| 5.5 | התראות מופיעות ב-NotificationsBell | ⬜ | |

**✅/❌ תהליך 5: _______**

---

## 🔄 תהליך 6: Edge Cases ואבטחה

| # | בדיקה | תוצאה | הערות |
|---|-------|--------|-------|
| 6.1 | מקרי קצה: תווים מיוחדים, סכום עשרוני (100.50), טלפון | ⬜ | |
| 6.2 | ללא auth → בקשה נכשלת | ⬜ | נסה: logout + שליחת בקשה |
| 6.3 | אבטחה: מנהל ענף לא יכול לאשר/לדחות | ⬜ | |
| 6.4 | אבטחה: גזבר רואה כל הבקשות (כל הענפים) | ⬜ | |

**✅/❌ תהליך 6: _______**

---

## 📊 סיכום

### סטטוס כללי:
- ✅ הכל עבר
- ❌ יש בעיות  
- ⚠️ חלקי

**הערות כלליות:**
________________________________________________________
________________________________________________________
________________________________________________________

---

## 🛠️ נתונים לבדיקה (לאחר הרצת test-data-clients.sql)

### לקוחות:
- **"חברת בדיקה א"** - יש sale, מופיע בפורטל מנהל ענף
- **"חברת בדיקה ב - שם ארוך מאוד"** - אין sale, לא מופיע
- **"לקוח-עם-מקפים_ותווים"** - אין sale, לא מופיע

### בדיקות מהירות:
1. חיפוש "בדיקה" → מוצא 2 לקוחות (אבל רק "חברת בדיקה א" מופיע בפורטל)
2. חיפוש "מקפים" → מוצא 1 לקוח (אבל לא מופיע בפורטל כי אין sale)

---

## 📝 SQL לבדיקות מהירות

```sql
-- בדיקת בקשות ממתינות
SELECT request_id, client_name, branch_id, status, created_at 
FROM client_request 
WHERE status = 'pending' 
ORDER BY created_at DESC;

-- בדיקת לקוחות עם sales לענף מסוים
SELECT DISTINCT c.client_id, c.name 
FROM client c
JOIN sale s ON c.client_id = s.client_id
WHERE s.branch_id = [BRANCH_ID];

-- בדיקת transactions שנוצרו
SELECT transaction_id, branch_id, transaction_type, value, due_date, status
FROM transaction
WHERE transaction_type = 'sale'
ORDER BY transaction_id DESC
LIMIT 10;
```

---

## 🔔 תיקונים שבוצעו במהלך ה-QA

### תיקון #1: ספירת התראות בפעמון
**בעיה:** הפעמון הציג רק את מספר בקשות הספקים, לא את בקשות הלקוחות.  
**תיקון:** השרת עכשיו סופר גם בקשות לקוחות וגם בקשות ספקים.  
**קובץ:** `naan-vrm-server/server.js` - endpoint `/api/notifications/pending-requests-count`

### תיקון #2: רענון מיידי של הפעמון
**בעיה:** הפעמון התעדכן רק כל 30 שניות, לא מיד אחרי אישור/דחייה.  
**תיקון:**
1. הורדת תדירות הרענון מ-30 שניות ל-5 שניות
2. הוספת מנגנון `NotificationContext` לרענון מיידי
3. קריאה ל-`triggerRefresh()` אחרי כל פעולה של אישור/דחייה

**קבצים שנוצרו/עודכנו:**
- `naan-vrm-client/src/context/NotificationContext.js` (חדש)
- `naan-vrm-client/src/components/layout/NotificationsBell.js`
- `naan-vrm-client/src/App.js`
- `naan-vrm-client/src/pages/DashboardPage.js`
- `naan-vrm-client/src/components/dashboard/ClientRequestsWidget.js`
- `naan-vrm-client/src/components/dashboard/SupplierRequestsWidget.js`

### תיקון #3: כפילויות לקוחות בפורטל מנהל ענף
**בעיה:** מנהל ענף רואה לקוח מופיע מספר פעמים אם יש לו מספר sales.  
**תיקון:** שימוש ב-`DISTINCT ON (c.client_id)` בשאילתת SQL.  
**קובץ:** `naan-vrm-server/server.js` - endpoint `/api/clients/search`

### תיקון #4: הוספת מספר לקוח בכרטיסים
**בעיה:** לא ניתן לראות את מספר הלקוח (client_id) בכרטיסים.  
**תיקון:** הוספת תג `#ID` בפינה הימנית של כל כרטיס לקוח.  
**קובץ:** `naan-vrm-client/src/components/branch-portal/BranchClientManagement.js`

### תיקון #5: "בחר אפשרות" נשאר ב-dropdown
**בעיה:** האפשרות "בחר אפשרות" נשארת גם אחרי שבוחרים אפשרות אחרת.  
**תיקון:** הצגת placeholder רק כאשר `!value`.  
**קובץ:** `naan-vrm-client/src/components/shared/Select.js`

### תיקון #6: אישור בקשה ללקוח קיים יוצר לקוח כפול
**בעיה:** כשמאשרים בקשה ללקוח קיים, נוצר לקוח חדש במקום רק sale חדש.  
**תיקון:** בדיקת `request.client_id` - אם קיים, משתמש בו ללא יצירת לקוח חדש.  
**קובץ:** `naan-vrm-server/server.js` - endpoint `/api/client-requests/:id/approve`

**לוגיקה:**
- אם `client_id` קיים → משתמש בלקוח הקיים + יוצר sale חדש
- אם `client_id` ריק → יוצר לקוח חדש + sale חדש

---

**תאריך ביצוע:** ___________  
**מבצע:** ___________

