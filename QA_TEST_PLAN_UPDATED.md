# 🧪 תוכנית בדיקה מעודכנת - פיצ'ר ניהול לקוחות

## 📊 מצב נתונים נוכחי

### לקוחות מרכזיים לבדיקה:
- **לקוח #17**: "חברת בדיקה א" - יש לו 2 sales (ענף #15401 + #99999)
- **לקוח #24**: "רייצ'ל צרכנות וכיף תמיד" - יש לו 2 sales (שניהם ענף #99999)
- **לקוחות #21-23**: כפילויות של אותו לקוח - **צריך לנקות!**

### בקשות ממתינות:
- בקשה #5, #6, #8, #10 - כולן pending

---

## 🎯 תוכנית הבדיקה

### שלב 1: ניקוי וה setup (5 דקות)

#### 1.1 ניקוי כפילויות
```sql
-- נמחק את הכפילויות של לקוח #24
DELETE FROM client WHERE client_id IN (21, 22, 23);
```

#### 1.2 ניקוי בקשות ישנות
```sql
-- נמחק בקשות ממתינות ישנות
DELETE FROM client_request WHERE request_id IN (5, 6, 8, 10);
```

---

### שלב 2: בדיקת תצוגה ראשונית (5 דקות)

#### תרחיש 2.1: פורטל מנהל ענף - תצוגת לקוחות
**כניסה:** manager@test.com / 123456

| # | בדיקה | תוצאה צפויה | תוצאה בפועל |
|---|--------|-------------|--------------|
| 2.1.1 | רשימת לקוחות מוצגת | רואה לקוחות + מספר ID | ⬜ |
| 2.1.2 | לקוח #17 מוצג עם מספר | "חברת בדיקה א (#17)" | ⬜ |
| 2.1.3 | לקוח #24 מוצג עם מספר | "רייצ'ל צרכנות וכיף תמיד (#24)" | ⬜ |
| 2.1.4 | אין כפילויות | כל לקוח מופיע פעם אחת | ⬜ |
| 2.1.5 | כפתור "הגש בקשה" מופיע | כפתור ירוק למעלה | ⬜ |

**סטטוס שלב 2.1:** ⬜

---

### שלב 3: בקשה ללקוח קיים (10 דקות) - **התיקון הקריטי!**

#### תרחיש 3.1: יצירת בקשה ללקוח קיים #17
**כניסה:** manager@test.com / 123456

| # | פעולה | תוצאה צפויה | תוצאה בפועל |
|---|-------|-------------|--------------|
| 3.1.1 | לחץ "הגש בקשה ללקוח חדש / דרישת תשלום" | נפתח modal | ⬜ |
| 3.1.2 | לחץ "בחר לקוח קיים" | נפתח dropdown עם חיפוש | ⬜ |
| 3.1.3 | חפש "חברת בדיקה א" | רואה לקוח #17 | ⬜ |
| 3.1.4 | בחר לקוח #17 | השדות מתמלאים אוטומטית | ⬜ |
| 3.1.5 | שדות פרטי לקוח נעולים? | כן, disabled | ⬜ |
| 3.1.6 | מלא סכום: 10000 | | ⬜ |
| 3.1.7 | בחר תנאי תשלום: "+30 ימים" | | ⬜ |
| 3.1.8 | מלא תיאור: "בדיקת sale חדש ללקוח קיים" | | ⬜ |
| 3.1.9 | שלח בקשה | הודעת הצלחה | ⬜ |

**סטטוס שלב 3.1:** ⬜

---

### שלב 4: אישור בקשה ללקוח קיים (10 דקות) - **הבדיקה הקריטית!**

#### תרחיש 4.1: אישור בקשה בפורטל גזבר
**כניסה:** treasury@test.com / 123456

| # | פעולה | תוצאה צפויה | תוצאה בפועל |
|---|-------|-------------|--------------|
| 4.1.1 | רואה בקשה חדשה בווידג'ט | "חברת בדיקה א (לקוח קיים #17)" | ⬜ |
| 4.1.2 | פעמון מציג התראה | יש התראה חדשה | ⬜ |
| 4.1.3 | לחץ "אשר" | נפתח dialog אישור | ⬜ |
| 4.1.4 | אשר בקשה | הודעת הצלחה | ⬜ |
| 4.1.5 | הבקשה נעלמת | כן | ⬜ |

**תוצאות במסד הנתונים:**
```sql
-- בדוק שלא נוצר לקוח חדש
SELECT COUNT(*) FROM client WHERE name = 'חברת בדיקה א';
-- צריך להיות: 1 (רק לקוח #17 המקורי)

-- בדוק שנוצר sale חדש
SELECT * FROM sale WHERE client_id = 17 ORDER BY sale_id DESC LIMIT 1;
-- צריך להיות: sale חדש עם לקוח #17

-- בדוק transaction
SELECT * FROM transaction WHERE sale_id = (SELECT MAX(sale_id) FROM sale WHERE client_id = 17);
-- צריך להיות: transaction עם value=10000, due_date +30 ימים
```

| # | בדיקת DB | תוצאה צפויה | תוצאה בפועל |
|---|----------|-------------|--------------|
| 4.1.6 | ספירת לקוחות בשם "חברת בדיקה א" | 1 (רק #17) | ⬜ |
| 4.1.7 | נוצר sale חדש? | כן, sale חדש עם client_id=17 | ⬜ |
| 4.1.8 | נוצר transaction? | כן, עם value=10000 | ⬜ |
| 4.1.9 | תאריך יעד נכון? | +30 ימים מהיום | ⬜ |

**סטטוס שלב 4.1:** ⬜

---

#### תרחיש 4.2: בדיקה בפורטל מנהל ענף
**חזרה ל:** manager@test.com / 123456

| # | בדיקה | תוצאה צפויה | תוצאה בפועל |
|---|--------|-------------|--------------|
| 4.2.1 | פעמון מציג התראה | "הבקשה אושרה" | ⬜ |
| 4.2.2 | רואה לקוח #17 | כן, פעם אחת | ⬜ |
| 4.2.3 | **לא נוצרה כפילות** | רק לקוח #17 אחד | ⬜ |
| 4.2.4 | יכול ליצור sale נוסף | כן | ⬜ |

**✅ **זהו התיקון הקריטי!** - לקוח קיים לא יוצר כפילות!**

**סטטוס שלב 4.2:** ⬜

---

### שלב 5: בקשה ללקוח חדש (10 דקות)

#### תרחיש 5.1: יצירת בקשה ללקוח חדש לגמרי
**כניסה:** manager@test.com / 123456

| # | פעולה | תוצאה צפויה | תוצאה בפועל |
|---|-------|-------------|--------------|
| 5.1.1 | לחץ "הגש בקשה" | נפתח modal | ⬜ |
| 5.1.2 | **לא** בוחר לקוח קיים | | ⬜ |
| 5.1.3 | מלא שם לקוח: "לקוח בדיקה חדש" | | ⬜ |
| 5.1.4 | מלא איש קשר: "יוסי כהן" | | ⬜ |
| 5.1.5 | מלא טלפון: "050-9999999" | | ⬜ |
| 5.1.6 | מלא סכום: 5000 | | ⬜ |
| 5.1.7 | תנאי תשלום: "מיידי" | | ⬜ |
| 5.1.8 | שלח בקשה | הודעת הצלחה | ⬜ |

**סטטוס שלב 5.1:** ⬜

---

#### תרחיש 5.2: אישור בקשה ללקוח חדש
**כניסה:** treasury@test.com / 123456

| # | פעולה | תוצאה צפויה | תוצאה בפועל |
|---|-------|-------------|--------------|
| 5.2.1 | רואה בקשה | "לקוח בדיקה חדש (לקוח חדש)" | ⬜ |
| 5.2.2 | אשר בקשה | הצלחה | ⬜ |

**תוצאות במסד הנתונים:**
| # | בדיקת DB | תוצאה צפויה | תוצאה בפועל |
|---|----------|-------------|--------------|
| 5.2.3 | נוצר לקוח חדש? | כן, client חדש | ⬜ |
| 5.2.4 | נוצר sale? | כן | ⬜ |
| 5.2.5 | נוצר transaction? | כן, value=5000 | ⬜ |

**סטטוס שלב 5.2:** ⬜

---

### שלב 6: בדיקות נוספות (10 דקות)

#### תרחיש 6.1: דחיית בקשה
| # | פעולה | תוצאה צפויה | תוצאה בפועל |
|---|-------|-------------|--------------|
| 6.1.1 | צור בקשה חדשה | | ⬜ |
| 6.1.2 | דחה בקשה עם הערה | | ⬜ |
| 6.1.3 | מנהל ענף רואה דחייה | "הבקשה נדחתה: [הערה]" | ⬜ |

**סטטוס שלב 6.1:** ⬜

---

#### תרחיש 6.2: Validations
| # | בדיקה | תוצאה צפויה | תוצאה בפועל |
|---|--------|-------------|--------------|
| 6.2.1 | סכום שלילי | שגיאה | ⬜ |
| 6.2.2 | סכום 0 | שגיאה | ⬜ |
| 6.2.3 | שדות חובה ריקים | שגיאה | ⬜ |
| 6.2.4 | אימייל לא תקין | שגיאה | ⬜ |

**סטטוס שלב 6.2:** ⬜

---

## 📈 סיכום תוצאות

### תיקונים שבוצעו:
1. ✅ תיקון רענון הפעמון (5 שניות + מיידי אחרי פעולות)
2. ✅ תיקון כפילויות בתצוגת מנהל ענף
3. ✅ הסרת "בחר אפשרות" מ-dropdown אחרי בחירה
4. ✅ הוספת הצגת מספר לקוח (#ID)
5. ✅ **תיקון קריטי**: אישור בקשה ללקוח קיים לא יוצר כפילות
6. ✅ תיקון כוכביות כפולות בשדות חובה

### תוצאות כוללות:
- **שלב 2** (תצוגה): ⬜ הושלם / ⬜ נכשל
- **שלב 3** (בקשה ללקוח קיים): ⬜ הושלם / ⬜ נכשל
- **שלב 4** (אישור - קריטי!): ⬜ הושלם / ⬜ נכשל
- **שלב 5** (לקוח חדש): ⬜ הושלם / ⬜ נכשל
- **שלב 6** (נוספות): ⬜ הושלם / ⬜ נכשל

---

## 🚀 הוראות הרצה

### לפני הבדיקה:
```bash
# 1. נקה נתונים ישנים
cd C:\Users\eseir\kibbutz-vrm-server\naan-vrm-server
node check-current-data.js

# 2. רענן דפדפן (Ctrl+Shift+R)

# 3. התחבר כמנהל ענף
# Email: manager@test.com
# Password: 123456
```

### במהלך הבדיקה:
- סמן ✅ / ❌ בכל שורה
- רשום הערות בעמודת "תוצאה בפועל"
- תעד screenshots אם יש בעיות

### לאחר הבדיקה:
- סכם את התוצאות
- דווח על בעיות שנמצאו
- עדכן את QA_PLAN_CLIENT_MANAGEMENT.md

---

**מוכן? בואו נתחיל!** 🎯

