# תכנית QA - תהליך חדש: לקוחות ודרישות תשלום

## 📋 סקירה כללית

התהליך פוצל לשני תהליכים נפרדים:

### תהליך 1: רישום לקוח חדש
1. **מנהל ענף** - שולח בקשה לרישום לקוח (רק פרטי לקוח)
2. **גזבר** - מאשר/דוחה את הבקשה
3. **תוצאה** - לקוח חדש נוצר במערכת

### תהליך 2: יצירת דרישת תשלום
1. **מנהל ענף** - בוחר לקוח קיים ויוצר דרישת תשלום (סכום, תאריך, תיאור)
2. **גזבר** - מאשר את הדרישה + בוחר תנאי תשלום + מספר חשבונית
3. **תוצאה** - דרישת תשלום פעילה במערכת

---

## 🔐 פרטי התחברות

| תפקיד | אימייל | סיסמה |
|-------|--------|-------|
| מנהל ענף | `manager@test.com` | `111222333` |
| גזבר | `treasury@test.com` | `111222333` |

---

## 📊 הכנת נתוני בדיקה

```bash
# הרצת סקריפט נתוני בדיקה
psql -U postgres -d naan_vrm -f test-data-qa-new-flow.sql
```

---

## ✅ תהליך 1: רישום לקוח חדש (End-to-End)

### 1.1: שליחת בקשה - פורטל מנהל ענף

**מטרה**: לוודא שמנהל ענף יכול לשלוח בקשה לרישום לקוח חדש

**צעדים**:
1. התחבר כמנהל ענף (`manager@test.com`)
2. עבור ל"ניהול לקוחות ודרישות תשלום"
3. לחץ על "בקשה ללקוח חדש"
4. מלא את הפרטים:
   - שם לקוח: `לקוח בדיקה QA 001`
   - שם איש קשר: `יוסי כהן`
   - טלפון: `050-1234567`
   - אימייל: `yossi@example.com`
   - עיר: `תל אביב`
   - רחוב: `דיזנגוף`
   - מספר בית: `100`
   - מיקוד: `6473921`
5. לחץ "שלח בקשה"

**תוצאה צפויה**:
- ✅ הבקשה נשלחה בהצלחה
- ✅ הודעה: "הבקשה נשלחה לאישור"
- ✅ הטופס נסגר
- ✅ **אין** שדות של עסקה (סכום, תנאי תשלום)

---

### 1.2: אישור בקשה - פורטל גזבר

**מטרה**: לוודא שגזבר יכול לאשר בקשה לרישום לקוח

**צעדים**:
1. התחבר כגזבר (`treasury@test.com`)
2. בדשבורד, בווידג'ט "בקשות לרישום לקוחות חדשים"
3. מצא את הבקשה: `לקוח בדיקה QA 001`
4. לחץ "אשר"
5. (אופציונלי) הוסף הערה: `אושר לבדיקה`
6. אשר את האישור

**תוצאה צפויה**:
- ✅ הבקשה אושרה
- ✅ לקוח חדש נוצר במערכת
- ✅ מנהל הענף קיבל התראה: "הבקשה לרישום לקוח אושרה - הלקוח זמין כעת ליצירת דרישות תשלום"
- ✅ **לא נוצרה** transaction או sale

---

### 1.3: בדיקת לקוח במערכת

**מטרה**: לוודא שהלקוח זמין ליצירת דרישות תשלום

**צעדים**:
1. התחבר כמנהל ענף
2. עבור ל"ניהול לקוחות ודרישות תשלום"
3. חפש את הלקוח: `לקוח בדיקה QA 001`

**תוצאה צפויה**:
- ✅ הלקוח מופיע ברשימה
- ✅ יש כפתור "+ צור דרישת תשלום"
- ✅ מספר לקוח מוצג (למשל: `#25`)

---

## ✅ תהליך 2: יצירת דרישת תשלום (End-to-End)

### 2.1: יצירת דרישת תשלום - פורטל מנהל ענף

**מטרה**: לוודא שמנהל ענף יכול ליצור דרישת תשלום ללקוח קיים

**צעדים**:
1. התחבר כמנהל ענף
2. עבור ל"ניהול לקוחות ודרישות תשלום"
3. לחץ על כרטיס הלקוח `לקוח בדיקה QA 001` או על "+ צור דרישת תשלום"
4. מלא את הפרטים:
   - סכום: `15000`
   - תאריך עסקה: (תאריך היום)
   - תיאור: `עסקה ראשונה - בדיקת QA`
5. לחץ "שלח לאישור"

**תוצאה צפויה**:
- ✅ דרישת התשלום נשלחה לאישור
- ✅ הודעה: "דרישת תשלום נשלחה לאישור הנהלת חשבונות!"
- ✅ הטופס נסגר
- ✅ **אין** שדה תנאי תשלום (זה יבחר על ידי הגזבר)

---

### 2.2: אישור דרישת תשלום - פורטל גזבר

**מטרה**: לוודא שגזבר יכול לאשר דרישת תשלום ולבחור תנאי תשלום

**צעדים**:
1. התחבר כגזבר
2. בדשבורד, בווידג'ט "דרישות תשלום ממתינות לאישור"
3. מצא את הדרישה: `לקוח בדיקה QA 001 - ₪15,000`
4. לחץ "אשר"
5. **בחר תנאי תשלום**:
   - אופציה 1: `מיידי (0 ימים)`
   - אופציה 2: `שוטף 15+ (15 ימים)`
   - אופציה 3: `שוטף 35+ (35 ימים)`
   - אופציה 4: `שוטף 50+ (50 ימים)` ← **ברירת מחדל**
6. (אופציונלי) הזן מספר חשבונית: `INV-2025-001`
7. לחץ "אשר דרישת תשלום"

**תוצאה צפויה**:
- ✅ דרישת התשלום אושרה
- ✅ תאריך יעד חושב אוטומטית לפי תנאי התשלום
- ✅ מנהל הענף קיבל התראה: "דרישת תשלום אושרה על ידי הנהלת חשבונות"
- ✅ הדרישה עברה לסטטוס `open` (פעילה)

---

### 2.3: בדיקת דרישת התשלום במערכת

**מטרה**: לוודא שדרישת התשלום פעילה ונכונה

**צעדים**:
1. התחבר כגזבר
2. עבור ל"מעקב תשלומים" / "דוחות"
3. חפש את דרישת התשלום

**תוצאה צפויה**:
- ✅ דרישת התשלום מופיעה
- ✅ סכום: `₪15,000`
- ✅ תנאי תשלום: `שוטף 50+` (או התנאי שנבחר)
- ✅ תאריך יעד: (תאריך היום + 50 ימים)
- ✅ מספר חשבונית: `INV-2025-001` (אם הוזן)
- ✅ סטטוס: `open`

---

## 🚀 תהליך בדיקה מהיר (Quick Smoke Test)

### מטרה
בדיקה מהירה של התהליך המלא - מבקשת לקוח ועד אישור דרישת תשלום.

### צעדים

#### שלב 1: בקשת לקוח חדש (מנהל ענף)
1. התחבר: `manager@test.com` / `111222333`
2. לחץ "בקשה ללקוח חדש"
3. מלא: שם=`Quick Test Client`, איש קשר=`Test`, טלפון=`050-9999999`
4. שלח בקשה
5. ✅ וודא: הבקשה נשלחה, **אין** שדות עסקה

#### שלב 2: אישור לקוח (גזבר)
1. התחבר: `treasury@test.com` / `111222333`
2. בווידג'ט "בקשות לרישום לקוחות" → מצא `Quick Test Client`
3. לחץ "אשר"
4. ✅ וודא: לקוח נוצר, **לא** נוצרה עסקה

#### שלב 3: יצירת דרישת תשלום (מנהל ענף)
1. חזור למנהל ענף
2. לחץ על כרטיס `Quick Test Client`
3. מלא: סכום=`10000`, תאריך=היום, תיאור=`test`
4. שלח לאישור
5. ✅ וודא: נשלח לאישור, **אין** תנאי תשלום

#### שלב 4: אישור דרישת תשלום (גזבר)
1. חזור לגזבר
2. בווידג'ט "דרישות תשלום ממתינות לאישור" → מצא `Quick Test Client - ₪10,000`
3. לחץ "אשר"
4. בחר תנאי תשלום: `שוטף 50+`
5. הזן חשבונית: `TEST-001`
6. אשר
7. ✅ וודא: אושר, תאריך יעד = היום + 50 ימים

---

## 🎯 נקודות בדיקה קריטיות

### ✅ הפרדת תהליכים
- [ ] בקשת לקוח **לא** כוללת פרטי עסקה
- [ ] אישור לקוח **לא** יוצר transaction או sale
- [ ] דרישת תשלום **רק** ללקוחות קיימים
- [ ] תנאי תשלום נבחרים **רק** על ידי הגזבר

### ✅ זרימת נתונים
- [ ] לקוח חדש מופיע מיד אחרי אישור
- [ ] דרישת תשלום ממתינה לאישור גזבר
- [ ] תאריך יעד מחושב נכון לפי תנאי תשלום
- [ ] מספר חשבונית נשמר נכון

### ✅ התראות
- [ ] מנהל ענף מקבל התראה על אישור לקוח
- [ ] גזבר מקבל התראה על בקשת לקוח חדשה
- [ ] גזבר מקבל התראה על דרישת תשלום חדשה
- [ ] מנהל ענף מקבל התראה על אישור דרישת תשלום

### ✅ ברירות מחדל
- [ ] תנאי תשלום: `שוטף 50+` (50 ימים)
- [ ] סטטוס transaction: `pending_approval` → `open` אחרי אישור

---

## 🐛 בעיות ידועות ותיקונים

### תיקון 1: הפרדת תהליכים
**בעיה**: בעבר, בקשת לקוח כללה גם פרטי עסקה ותנאי תשלום.
**תיקון**: פיצול לשני תהליכים נפרדים - רישום לקוח ודרישת תשלום.

### תיקון 2: בחירת תנאי תשלום
**בעיה**: מנהל ענף בחר תנאי תשלום, שזה תפקיד הגזבר.
**תיקון**: תנאי תשלום נבחרים רק על ידי הגזבר באישור דרישת התשלום.

### תיקון 3: מספר חשבונית
**בעיה**: מספר חשבונית היה אקראי.
**תיקון**: הגזבר מזין מספר חשבונית באישור דרישת התשלום.

---

## 📝 הערות נוספות

- התהליך החדש מאפשר גמישות רבה יותר
- ניתן לרשום לקוח מבלי ליצור עסקה מיד
- ניתן ליצור מספר דרישות תשלום לאותו לקוח
- הגזבר שולט על תנאי התשלום ומספרי החשבוניות

---

**תאריך עדכון אחרון**: 11/11/2025
**גרסה**: 2.0 - תהליך חדש מופרד


